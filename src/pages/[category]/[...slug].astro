---
import { getCollection } from "astro:content";
import { allCategories, categoryMeta, GardenCategory } from "@/lib/categories";
import Layout from "@/layouts/Layout.astro";
import type { GardenEntry } from "@/lib/types";
import { Breadcrumbs } from "@/components/Breadcrumbs";

export async function getStaticPaths() {
  const allPaths = await Promise.all(
    allCategories.map(async (category) => {
      const entries = await getCollection(category as GardenCategory);
      return entries.map((entry) => ({
        params: {
          category,
          slug: entry.slug,
        },
        props: { entry, category, slug: entry.slug }, 
      }));
    })
  );

  return allPaths.flat();
}

interface Props {
  entry: GardenEntry;
  category: GardenCategory;
  slug: string;
}

const { entry, category, slug } = Astro.props as Props;
const { Content, headings } = await entry.render();

const Icon = categoryMeta[category].icon;

const baseUrl = import.meta.env.BASE_URL

const breadcrumbItems = [
  { label: "Home", href: baseUrl },
  { label: categoryMeta[category].label, href: `${baseUrl}${category}` },
];
// Construit les sous-chemins et labels Ã  partir du slug
let accumulatedPath = `${baseUrl}${category}`;
slug.split("/").forEach((segment, index) => {
  accumulatedPath += `/${segment}`;
  const label = segment.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  breadcrumbItems.push({ label, href: accumulatedPath });
});
---

<Layout title={entry.data.title} toc={headings} category={category}>
  <article class="mx-auto">
    <section class="flex flex-row items-center gap-2">
        <Icon
            className="w-10 h-10"
            style={{ stroke: `var(--${categoryMeta[category].color})` }}
          />
      <h2 class="text-3xl font-medium">{entry.data.title}</h2>
    </section>
    <section class="mt-4 mb-8">
      <Breadcrumbs
        client:load
        items={breadcrumbItems}
      />
    </section>
    <div class="hero-image mt-7">
      {
        entry.data.heroImageDark && entry.data.heroImageLight && (
          <img
        src={baseUrl + entry.data.heroImageLight}
        alt=""
        class="block dark:hidden w-full h-auto rounded-md my-7"
      />
      <img
        src={baseUrl + entry.data.heroImageDark}
        alt=""
        class="hidden dark:block w-full h-auto rounded-md my-7"
      />
        )
      }
    </div>
    <div class="prose-custom max-w-none w-full" style={`--category-color: var(--${categoryMeta[category].color});`}>
      <Content />
    </div>
  </article>
</Layout>
